<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Model</title>
  </head>
  <body>
    <div id="app"></div>
    <script src="scripts/underscore-min.js"></script>
    <script src="scripts/jquery-3.5.1.min.js"></script>
    <script src="scripts/backbone-min.js"></script>

    <script>
      Person = Backbone.Model.extend({
        // Setando valores default para o modelo.
        defaults: {
          // id: 123, // atributo manual
          idAttribute: "id", // atributo automatico
          rnumber: 0,

          // It is used for the instance of the model and returns
          // a url where the model's resource is located.
          urlRoot: "/tutorialspoint/backbonejs",
        },

        // Método de inicialização do modelo (instanciação)
        initialize: function () {
          document.write("Model initialized!");

          // change: disparado quando alterado o valor de um atributo referenciado.
          this.bind("change:name", function (model) {
            console.log("alterado!");
          });

          // Segundo exemplo sobre change:
          this.bind("change:rnumber", function (model) {
            console.log(model.attributes.rnumber);
          });

          // Sync => It can be used to communicate with the server and to represent the state of a model.
          Backbone.sync = function (method, model) {
            console.log(method, model);
          };

          // Método para escutar possiveis erros de validação:
          this.bind("invalid", function (error) {
            document.write(error);
          });
        },

        // método do modelo para validação de atributos:
        validate: function (attrs) {
          if (attrs.age < 0) {
            return "Invalid age.";
          }
          if (!attrs.name) {
            return "Empty name.";
          }
        },

        // Método parse:
        parse: function (response, options) {
          console.log("Parse option: " + JSON.stringify(options));
          console.log("response: " + JSON.stringify(response));
        },
      });

      var p = new Person();

      p.set({ id: 123, name: "Anderson", status: true });
      console.log(`${p.get("id")} - ${p.get("name")} - ${p.get("status")}`);

      // Verificando se tem um atributo:
      console.log(p.has("occupation"));

      // Removendo um atributo:
      p.unset("status");
      console.log(`${p.get("id")} - ${p.get("name")} - ${p.get("status")}`);

      /*
        É quase como a função get , mas
        retorna a versão com escape em HTML do atributo
        de um modelo.
      */
      console.log(p.escape("name"));

      // Remove todos os atributos:
      p.clear();
      console.log(`${p.get("id")} - ${p.get("name")} - ${p.get("status")}`);

      // Cid => It is a client id which is auto generated by Backbone,
      // so that the model can be uniquely identified on the client.
      console.log(p.cid);

      // Atualizando atributo:
      p.set({ name: "Anderson C." });
      console.log(p.get("name"));

      function generateNumber() {
        p.set("rnumber", Math.random());
      }

      // It returns a copy of the attributes as an object for JSON stringification.
      console.log(p.toJSON());

      // Chamando o sync:
      p.save();

      // It accepts data from the server by delegating the sync() method in the model.
      p.fetch();

      // It destroys or removes the model from the server by using the Backbone.sync
      // method which delegates the HTTP "delete" request.
      p.destroy();

      /*
      p.on('invalid', function() {
        this.arguments;
      });
      */

      p.set({ name: "" }, { validate: true });
      console.log(p.validationError);

      // Verificando se esta valido de acordo com o validate:
      console.log(p.isValid());

      // Utilizando o parse na instancia:
      var person = {
        data: [
          {
            id: 777,
            name: "Mary",
            salary: 5421.11,
            status: true,
            birthday: new Date(1981, 11, 12),
          },
        ],
      };

      // Executando o método parse:
      var personParse = new Person({ model: person }, { parse: true });
      console.log(personParse);

      // clonando instancias:
      var c = personParse.clone();
      console.log(JSON.stringify(c));

      // Verificando se foi alterado:
      console.log(p.hasChanged());

      // verificando se isNew:
      console.log(p.isNew());
    </script>
    <button onclick="generateNumber()">GENERATE</button>

    <!-- ************************************************************************ -->

    <script>
      var names = new Backbone.Model({
        name1: "Mary",
        name2: "John",
        name3: "Anne",
        name4: "Jason",
      });

      names.on("change", function () {
        console.log(JSON.stringify(names));
        console.log(JSON.stringify(names.changedAttributes()));
      });

      names.set({
        name3: "Carmen",
        name2: "Sarah",
      });

      console.log(names.previous("name2")); // nome anterior!

      // Valores antes das mudanças:
      console.log(JSON.stringify(names.previousAttributes()));
    </script>
  </body>
</html>
